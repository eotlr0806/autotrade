<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ATS - Auto Trading Solution</title>

    <!-- Global stylesheets -->
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,100,500,700,900" rel="stylesheet" type="text/css">
    <link href="../bootstrap/assets/css/icons/icomoon/styles.css" rel="stylesheet" type="text/css">
    <link href="../bootstrap/assets/css/bootstrap.css" rel="stylesheet" type="text/css">
    <link href="../bootstrap/assets/css/core.css" rel="stylesheet" type="text/css">
    <link href="../bootstrap/assets/css/components.css" rel="stylesheet" type="text/css">
    <link href="../bootstrap/assets/css/colors.css" rel="stylesheet" type="text/css">
    <!-- /global stylesheets -->
</head>

<style>
    .row {
        margin-bottom:7px;
    }
    
    .ask-header {
        background-color: #E6EBFF;
        color:blue;
    }

    .ask-body {
        color:blue;
    }

    .bid-header {
        background-color: #FFE7E9;
        color:red;
    }

    .bid-body {
        color : red;
    }
</style>

<body>
    <!-- Page container -->
    <div class="page-container">

        <!-- Page content -->
        <div class="page-content">
            <div class="content-wrapper">
                <!-- Page header -->
                <div class="page-header">
                    <div class="page-header-content">
                        <div class="page-title">
                            <h4><i class="icon-arrow-left52 position-left"></i> <span class="text-semibold">운영 관리</span> - 거래 관리</h4>
                        </div>
                    </div>
                </div>
                <!-- /page header -->

                <!-- Content area -->
                <div class="content">
                    <!-- bot field -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="panel">
                                <div class="panel-heading">
                                    <h5 class="panel-title text-bold">코인 설정</h5>
                                    <div class="heading-elements">
                                        <ul class="icons-list">
                                            <li><a data-action="collapse"></a></li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="panel-body">
                                    <div class="form-inline">
                                        <div class="form-group">
                                            <label class="text-bold" for="filter_exchange">거래소</label>
                                            <select name="fSpot" id="filter_exchange" class="form-control">
                                                <!--<option value="NONE"> 선택 </option>-->
                                            </select>
                                        </div>

                                        <div class="form-group">
                                            <label class="text-bold" for="filter_coin">코인</label>
                                            <select name="fSpot" id="filter_coin" class="form-control"></select>
                                            <button onclick="fncObj.onClickRealPriceBtn()" class="btn btn-primary" style="margin-left:10px;">호가 조회</button>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /bot field -->

                    <!-- 2 columns form -->
                    <div class="row">
                        <!-- 자전 거래 -->
                        <div class="col-md-12">
                            <div class="panel panel-flat">
                                <div class="panel-heading">
                                    <h5 class="panel-title text-bold">거래</h5>
                                    <div class="heading-elements">
                                        <ul class="icons-list">
                                            <li><a data-action="collapse"></a></li>
                                        </ul>
                                    </div>
                                </div>

                                <div class="panel-body">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="row">
                                                <div class="form-group">
                                                    <label class="control-label col-sm-2">주문 가격</label>
                                                    <div class="radio col-sm-8" style="margin-top:0px;">
                                                        <input id="trade_price" type="text" placeholder="100" class="form-control" min="0" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" >
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="form-group">
                                                    <label class="control-label col-sm-2">주문 수량</label>
                                                    <div class="radio col-sm-8" style="margin-top:0px;">
                                                        <input id="trade_cnt" type="text" placeholder="100" class="form-control" min="0" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*)\./g, '$1');" >
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="text-right">
                                                <button onclick="fncObj.postTrade(TRADE_ACTION.BUY)" type="submit" class="btn btn-danger">매 수</button>
                                                <button onclick="fncObj.postTrade(TRADE_ACTION.SELL)" type="submit" class="btn btn-primary">매 도</button>
<!--                                                <button onclick="fncObj.postTrade(TRADE_LIST.AUTOTRADE);" type="submit" class="btn btn-primary">저 장</button>-->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>


                </div>
                <!-- /content area -->
            </div>
        </div>
    </div>

    <!-- Real Time Price Modal container -->
    <div id="modal_coin_price" class="modal fade">
        <div class="modal-dialog modal-mg" >
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h5 class="modal-title text-bold">실시간 호가</h5>
                </div>
                <div class="form-horizontal">
                    <div class="modal-body" >
                        <div class="form-group">
                            <label class="control-label text-bold col-sm-12">호가</label>
                            <div class="col-sm-12" style="font-size:11px;">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th class="text-bold">가격</th>
                                                <th class="text-bold">수량</th>
                                            </tr>
                                        </thead>
                                        <tbody id="modal_coin_price_body">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer">
                            <input onclick="fncObj.makerealPriceTable()" type="button" class="btn btn-info" value="갱신">
                            <input type="button" class="btn" data-dismiss="modal" value="닫기">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- /Real Time Price Modal container -->
    
</body>



<!-- Core JS files -->
<script type="text/javascript" src="../bootstrap/assets/js/plugins/loaders/pace.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/core/libraries/jquery.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/core/libraries/bootstrap.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/loaders/blockui.min.js"></script>
<!-- /core JS files -->

<!-- Theme JS files -->
<script type="text/javascript" src="../bootstrap/assets/js/plugins/forms/styling/uniform.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/editors/wysihtml5/wysihtml5.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/editors/wysihtml5/toolbar.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/editors/wysihtml5/parsers.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/editors/wysihtml5/locales/bootstrap-wysihtml5.ua-UA.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/plugins/notifications/jgrowl.min.js"></script>

<script type="text/javascript" src="../bootstrap/assets/js/plugins/notifications/pnotify.min.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/core/app.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/pages/editor_wysihtml5.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/pages/components_notifications_pnotify.js"></script>
<script type="text/javascript" src="../bootstrap/assets/js/pages/extension_blockui.js"></script>
<!-- /theme JS files -->

<!-- Common Lib -->
<script type="text/javascript" src="../common/js/commonScript.js"></script>
<!-- /Common Lib -->

<!-- -->
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>


<script>

    const STOP               = "STOP";
    const UPBIT_URL          = "https://api.upbit.com/v1/ticker?markets=";

    let clickedAutoMode      = '';
    let clickedLiquidityMode = '';
    let clickedFishingMode   = '';
    let exchangesList        = [];
    let loginUserId          = '';
    let liquiditySelfTick    = [];

    // init page
    $(document).ready(() => {
        fncObj.initPage();
    })


    /** Function object **/
    let fncObj = {

        // 페이지 로드 시 초기값 셋팅을 위한 함수
        initPage : async () => {
            loginUserId = $('#server_user_id').val();                   // Set user id

            let response = await common.get(API.EXCHANGE);              // Get excahgne, coin list
            if(response === null){
                common.noti("거래소 조회","거래소 조회에 실패했습니다.","error");
                return;
            }

            exchangesList = response.data;
            dataObj.setExchangeCoin();                              // Set exchange

            // checker class로 인해 span 태그가 생성 이후 해당 태그에 이벤트 부여.
            setTimeout(() => {
                // class checker에 대한 click event
                $('.checker').on('click',item => {
                    let str   = item.currentTarget.id.toString();
                    let index = str.indexOf('-') + 1;
                    let id    = str.substring(index);

                    // 값이있다면
                    if(liquiditySelfTick.includes(id)){
                        liquiditySelfTick = liquiditySelfTick.filter(item => item != id);
                    }
                    // 값이 없다면
                    else{
                        liquiditySelfTick.push(id);
                    }
                });
            },1000);
        },

        // 호가 조회 함수
        onClickRealPriceBtn : async () =>{
            if($('#filter_exchange').val() == 'NONE' || $('#filter_coin').val() == 'NONE'){
                common.noti("호가 조회", "거래소와 코인을 선택해주세요","error");
                return;
            }
            await fncObj.makerealPriceTable();

            $('#modal_coin_price').modal('show');
        },

        // 호가 조회 시, 데이터 조회 및 셋팅
        makerealPriceTable : async () => {
            $('#modal_coin_price_body').empty();

            let filterExchangeNm = $('#filter_exchange').val();
            let coin             = $('#filter_coin').val();
            let url              = API.ORDER_BOOK + `?exchange=${filterExchangeNm}&currency=${coin}&userId=${loginUserId}`;
            let response         = await common.get(url);

            if (response === null){
                common.noti("호가 조회","호가 조회에 실패했습니다.","error");
                return;
            }

            let data = JSON.parse(response.data);
            let dynamicText = dataObj.setRealPriceTable(filterExchangeNm, data);
            $('#modal_coin_price_body').append(dynamicText);
        },

        postTrade : async (mode) => {
            // check mode
            let params = fncObj.setDataBeforePost(mode);

            if(params != CODE_ERROR){
                let returnVal = await common.post(API.TRADE_ACTION, params);
                if (!returnVal || returnVal.status !== CODE.SUCCESS){
                    common.noti("기본 거래","해당 코인에 대해 기본 거래가 불가능합니다.","error");
                    return;
                }else{
                    common.noti("기본 거래","거래 요청 완료","success");
                    return;
                }
            }
        },

        // 자전 거래 데이터 셋팅
        setDataBeforePost : (mode) => {
            if(!fncObj.validateParam()){
                return CODE_ERROR;
            }

            let body = {
                type       : mode,
                price      : dataObj.validateDot($('#trade_price').val()),
                cnt        : dataObj.validateDot($('#trade_cnt').val()),
                exchangeId : $('#filter_exchange').val(),
                coinWithId : $('#filter_coin').val(),
                userId     : loginUserId,
            };
            return body;
        },




        // 공통 부분
        validateParam : () => {
            if($('#filter_exchange').val() == '' || $('#filter_exchange').val() == undefined || $('#filter_exchange').val() == 'NONE'){
                return common.noti("수동 거래","상단의 거래소를 선택해주세요.","error");
            }else if($('#filter_coin').val() == '' || $('#filter_coin').val() == undefined || $('#filter_coin').val() == 'NONE'){
                return common.noti("수동 거래","상단의 코인을 선택해주세요.","error");
            }else if ($('#trade_price').val() == ''){
                return common.noti("수동 거래","가격을 입력해주세요.","error");
            }else if ($('#trade_cnt').val() == ''){
                return common.noti("수동 거래","수량을 입력해주세요.","error");
            }
            return true;
        },
    };
    /** Function object **/



    /** Function object for data setter / getter **/
    let dataObj = {
        // 호가 리스트 조회
        setRealPriceTable : (exchange, data) => {
            let dynamicText = "";
            try{
                let limitCnt = 10;  // 기존에 10개

                ask = data.ask.slice(0,limitCnt).reverse() || []   // sell
                bid = data.bid.slice(0,limitCnt) || []             // buy

                ask.forEach(item => {
                    dynamicText += `
                    <tr>
                        <td class="text-bold ask-header">${item.price}</td>
                        <td class="text-bold ask-body">${item.qty}</td>
                    </tr>`;
                })

                bid.forEach(item => {
                    dynamicText += `
                    <tr>
                        <td class="text-bold bid-header">${item.price}</td>
                        <td class="text-bold bid-body">${item.qty}</td>
                    </tr>`;

                });
            }catch(e){
                common.noti("실시간 호가 조회","코인 정보를 확인해주세요.\n 이상이 없을 시, 다시 시도해주세요.","error");
            }


            return dynamicText;
            
        },
          
        // 페이지 로드 이후, 거래소 정보 셋팅을 위한 함수
        setExchangeCoin : () => {
            $('#filter_exchange').empty();
            $('#filter_coin').empty();
            let dynamicText = "<option value='NONE'>선택</option>";
            exchangesList.forEach(exchange => {
                dynamicText += `
                    <option value=${exchange.id}>
                        ${exchange.exchangeName}
                    </option>`;
            });
            $('#filter_exchange').append(dynamicText);
        },

        validateDot : target => {
            if (target.indexOf('.') == 0){
                return `0${target}`;
            }else if (target.indexOf('.') == target.length -1){
                return `${target}0`;
            }else{
                return target;
            }
        }

        
    }
    /** Function object for data setter,getter **/





    /** Event **/
    $('.custom-radio').on('click', event => {
        let name = event.currentTarget.name;
        if(name == 'autotrade'){
            clickedAutoMode      = event.currentTarget.id;
        }else if(name == 'liquidity'){
            clickedLiquidityMode = event.currentTarget.id;
        }else if(name = 'fishing'){
            clickedFishingMode   = event.currentTarget.id;
        }
    })

    // 거래소 선택 시, 코인 정보 등록
    $('#filter_exchange').on('change', () => {
        $('#filter_coin').empty();

        let selectedExchange = $('#filter_exchange').val();
        if(selectedExchange == 'NONE'){
            $('#filter_coin').empty();
        }else{
            let dynamicText = "<option value='NONE'>선택</option>";
            exchangesList.forEach(exchange => {
                if(Object.keys(exchange).length > 0){
                    if(exchange.id == selectedExchange){
                    exchange.exchangeCoin.forEach(coin => {
                        dynamicText += `
                            <option value=${coin.coinCode};${coin.id}>
                                ${coin.coinName}
                            </option>`;
                        })
                    }
                }
            })
            $('#filter_coin').append(dynamicText);
        }

        if(selectedExchange == EXCHANGE_LIST.COINONE){
            common.noti("거래소","코인원의 경우 모든 서비스는 원화 기준입니다.","success");
        }else {
            common.noti("거래소","모든 서비스는 각 코인 등록시 등록한 통화 기준입니다.","success");
        }
    })
    /** Event **/

</script>



<input type="hidden" id="server_user_id" th:value="${userId}" />
<!-- TODO :
 1. 요청 시 예외 처리-->